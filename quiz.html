<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Discover your lunch personality! Take this 2-minute quiz to find out if you're an Optimizer, Explorer, Foodie, or one of 5 other types.">

    <!-- Open Graph / Social Media -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://lunchnear.me/quiz">
    <meta property="og:title" content="What's Your Lunch Personality? | LunchNear.me">
    <meta property="og:description" content="Take the 2-minute quiz to discover your lunch personality. Join 10,000+ SF workers who found theirs!">
    <meta property="og:image" content="https://lunchnear.me/og-quiz.png">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="What's Your Lunch Personality?">
    <meta name="twitter:description" content="Take the 2-minute quiz to discover your lunch personality!">
    <meta name="twitter:image" content="https://lunchnear.me/og-quiz.png">

    <title>What's Your Lunch Personality? | LunchNear.me</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŽ¯</text></svg>">
    <style>
        html { scroll-behavior: smooth; }
        body { font-family: 'Inter', sans-serif; }
        .gradient-text {
            background: linear-gradient(135deg, #F97316 0%, #EC4899 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .gradient-bg {
            background: linear-gradient(135deg, #F97316 0%, #EC4899 100%);
        }
        .quiz-option {
            transition: all 0.2s ease;
        }
        .quiz-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(249, 115, 22, 0.15);
        }
        .quiz-option.selected {
            border-color: #F97316;
            background: linear-gradient(135deg, rgba(249, 115, 22, 0.05) 0%, rgba(236, 72, 153, 0.05) 100%);
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out forwards;
        }
        @keyframes confetti {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(-100px) rotate(720deg); opacity: 0; }
        }
        .confetti {
            animation: confetti 1s ease-out forwards;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        stone: { 850: '#1f1f1e' },
                        brand: { orange: '#F97316', pink: '#EC4899' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-b from-orange-50 to-white text-stone-900 antialiased min-h-screen">

    <!-- Quiz Container -->
    <div id="quiz-app" class="max-w-2xl mx-auto px-4 py-8">
        <!-- Header -->
        <header class="mb-8">
            <a href="index.html" class="inline-flex items-center gap-2 text-stone-500 hover:text-stone-700 transition-colors text-sm">
                <i data-feather="arrow-left" class="w-4 h-4"></i>
                Back to Home
            </a>
        </header>

        <!-- Quiz Content (will be replaced by JavaScript) -->
        <div id="quiz-content">
            <!-- Title -->
            <div class="text-center mb-8">
                <h1 class="text-3xl md:text-4xl font-bold text-stone-900 tracking-tight">
                    What's Your <span class="gradient-text">Lunch Personality?</span>
                </h1>
                <p class="mt-3 text-stone-500">Join 10,000+ SF workers who discovered theirs</p>
            </div>

            <!-- Progress Bar -->
            <div id="progress-container" class="mb-8">
                <div class="flex justify-between text-sm text-stone-500 mb-2">
                    <span id="progress-text">Question 1 of 7</span>
                    <span id="progress-percent">14%</span>
                </div>
                <div class="h-2 bg-stone-200 rounded-full overflow-hidden">
                    <div id="progress-bar" class="h-full gradient-bg rounded-full transition-all duration-300" style="width: 14%"></div>
                </div>
            </div>

            <!-- Question Card -->
            <div id="question-card" class="bg-white rounded-2xl shadow-xl p-6 md:p-8 animate-fade-in">
                <h2 id="question-text" class="text-xl md:text-2xl font-semibold text-stone-900 mb-6"></h2>
                <div id="options-container" class="space-y-3"></div>
            </div>

            <!-- Social Proof -->
            <div class="mt-6 text-center">
                <p class="text-sm text-stone-400 flex items-center justify-center gap-2">
                    <span class="inline-block w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                    <span id="live-count">2,847</span> people took this quiz today
                </p>
            </div>
        </div>

        <!-- Results (hidden initially) -->
        <div id="results-content" class="hidden">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>

    <script>
        // Supabase Client
        const SUPABASE_URL = 'https://ekuqmcouqchzrwnvnzkr.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrdXFtY291cWNoenJ3bnZuemtyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ4NzE5NDAsImV4cCI6MjA4MDQ0Nzk0MH0.T8AMvu_NPsIyQ5DFXuozphgChNGHi3jnuJm7JgAVdWk';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Current quiz result ID (set after submission)
        let currentResultId = null;

        // Quiz Data
        const questions = [
            {
                id: 'q1',
                question: "It's 11:45am. What's your first thought?",
                options: [
                    { text: "Already know where I'm going", points: { habit: 3, optimizer: 1 } },
                    { text: "Time to find somewhere new!", points: { explorer: 3, foodie: 1 } },
                    { text: "Let me check what's quick nearby", points: { optimizer: 3, budget: 1 } },
                    { text: "Who's free for lunch?", points: { social: 3, mood: 1 } }
                ]
            },
            {
                id: 'q2',
                question: "Your ideal lunch budget is:",
                options: [
                    { text: "Whatever gets me the best food", points: { foodie: 3, explorer: 1 } },
                    { text: "Under $12, always", points: { budget: 3, habit: 1 } },
                    { text: "Depends on the day and mood", points: { mood: 3, social: 1 } },
                    { text: "I meal prep, so basically $0", points: { health: 3, budget: 2 } }
                ]
            },
            {
                id: 'q3',
                question: "You're picking a spot for a group. You prioritize:",
                options: [
                    { text: "Everyone's dietary needs", points: { health: 2, social: 3 } },
                    { text: "Somewhere with great photos", points: { foodie: 3, explorer: 1 } },
                    { text: "Fast service, we're all busy", points: { optimizer: 3, budget: 1 } },
                    { text: "A place we haven't tried", points: { explorer: 3, mood: 1 } }
                ]
            },
            {
                id: 'q4',
                question: "Your go-to lunch order is:",
                options: [
                    { text: "The same thing every time", points: { habit: 3, optimizer: 2 } },
                    { text: "Whatever looks healthy", points: { health: 3, budget: 1 } },
                    { text: "Whatever I'm craving that day", points: { mood: 3, foodie: 1 } },
                    { text: "The most interesting thing on the menu", points: { explorer: 3, foodie: 2 } }
                ]
            },
            {
                id: 'q5',
                question: "How do you discover new lunch spots?",
                options: [
                    { text: "Friends' recommendations", points: { social: 3, habit: 1 } },
                    { text: "Instagram/TikTok food accounts", points: { foodie: 3, explorer: 2 } },
                    { text: "I stick to what I know", points: { habit: 3, budget: 1 } },
                    { text: "Walk around and see what's new", points: { explorer: 3, mood: 1 } }
                ]
            },
            {
                id: 'q6',
                question: "A coworker suggests trying a new place. You think:",
                options: [
                    { text: "Sure, if it's quick", points: { optimizer: 3, social: 1 } },
                    { text: "Only if it has good reviews", points: { foodie: 2, habit: 2 } },
                    { text: "Is it in my budget?", points: { budget: 3, health: 1 } },
                    { text: "Yes! Let's go!", points: { explorer: 3, social: 2 } }
                ]
            },
            {
                id: 'q7',
                question: "What frustrates you most about lunch?",
                options: [
                    { text: "Wasting time deciding", points: { optimizer: 3, habit: 2 } },
                    { text: "Eating the same thing again", points: { explorer: 3, mood: 1 } },
                    { text: "Spending too much", points: { budget: 3, health: 1 } },
                    { text: "Finding healthy options", points: { health: 3, foodie: 1 } },
                    { text: "Coordinating with others", points: { social: 2, optimizer: 2 } },
                    { text: "Nothing looking appetizing", points: { mood: 3, explorer: 1 } }
                ]
            }
        ];

        const personalities = {
            optimizer: {
                name: "The Optimizer",
                emoji: "âš¡",
                tagline: "Time is money, especially at lunch",
                description: "You're efficiency-focused and hate wasting time deciding where to eat. You'd rather spend 30 seconds picking the perfect spot than 30 minutes debating. You value speed, convenience, and getting back to what matters.",
                strengths: ["Quick decision maker", "Values efficiency", "Rarely regrets choices", "Great at time management"],
                weaknesses: ["May miss hidden gems", "Can seem impatient to others", "Sometimes sacrifices quality for speed"],
                appHook: "AI picks the perfect spot in 30 seconds",
                famousExamples: ["Elon Musk", "Mark Zuckerberg", "Tim Cook"],
                color: "#F97316",
                percentage: 23
            },
            explorer: {
                name: "The Explorer",
                emoji: "ðŸ—ºï¸",
                tagline: "Life's too short for the same lunch twice",
                description: "You're always seeking new spots and get bored eating at the same place twice. Every lunch is an adventure, and you love discovering hidden gems before they become popular.",
                strengths: ["Adventurous eater", "Always finds new spots", "Great recommendations", "Open-minded"],
                weaknesses: ["Decision paralysis with too many options", "May overlook reliable favorites", "Can be disappointed when spots don't live up to hype"],
                appHook: "Daily new recommendations you've never tried",
                famousExamples: ["Anthony Bourdain", "Guy Fieri", "Gordon Ramsay"],
                color: "#10B981",
                percentage: 18
            },
            habit: {
                name: "The Creature of Habit",
                emoji: "ðŸ ",
                tagline: "If it ain't broke, why try somewhere new?",
                description: "You've found your spots and you're sticking to them. Why risk a bad lunch when you know exactly what you're getting at your regulars? You value consistency and reliability.",
                strengths: ["Knows what you like", "Builds relationships with staff", "Never disappointed", "Efficient ordering"],
                weaknesses: ["May miss out on great new spots", "Can be inflexible in groups", "Routine might feel boring to others"],
                appHook: "Track favorites, discover similar vibes",
                famousExamples: ["Barack Obama", "Warren Buffett", "Steve Jobs"],
                color: "#6366F1",
                percentage: 15
            },
            social: {
                name: "The Social Luncher",
                emoji: "ðŸ‘¥",
                tagline: "It's not about the food, it's about the people",
                description: "For you, lunch is about connection. The food is secondary to the company. You're the one organizing team lunches, remembering everyone's dietary restrictions, and making sure everyone's included.",
                strengths: ["Great at group coordination", "Remembers everyone's preferences", "Builds team morale", "Inclusive"],
                weaknesses: ["Struggles with solo decisions", "May prioritize group over personal preference", "Coordination can be exhausting"],
                appHook: "Group voting - never argue about where to go",
                famousExamples: ["Oprah Winfrey", "Ellen DeGeneres", "Jimmy Fallon"],
                color: "#EC4899",
                percentage: 14
            },
            budget: {
                name: "The Budget Boss",
                emoji: "ðŸ’°",
                tagline: "A great lunch doesn't have to break the bank",
                description: "You know the value of a dollar and refuse to overpay for lunch. You've found the best spots with the biggest portions at the lowest prices. Your colleagues think you're frugal, but you call it smart.",
                strengths: ["Financially savvy", "Finds hidden value spots", "Great at stretching a budget", "Never overpays"],
                weaknesses: ["May miss premium experiences", "Can seem cheap to others", "Price sometimes trumps quality"],
                appHook: "Filter by price, never overspend on lunch",
                famousExamples: ["Dave Ramsey", "Mark Cuban", "Suze Orman"],
                color: "#22C55E",
                percentage: 12
            },
            foodie: {
                name: "The Foodie",
                emoji: "ðŸ“¸",
                tagline: "Life's too short for mediocre food",
                description: "You're all about quality. Instagram-worthy plates, artisanal ingredients, and chef-driven menus are your jam. You follow food blogs, have opinions about olive oil, and your camera roll is 70% food pics.",
                strengths: ["Appreciates quality", "Great taste in restaurants", "Knows the best spots", "Elevates team lunches"],
                weaknesses: ["Can be perceived as snobby", "Budget isn't always a priority", "Quick lunch isn't in the vocabulary"],
                appHook: "Curated picks with photos and reviews",
                famousExamples: ["Chrissy Teigen", "David Chang", "Padma Lakshmi"],
                color: "#F59E0B",
                percentage: 11
            },
            health: {
                name: "The Health Nut",
                emoji: "ðŸ¥—",
                tagline: "You are what you eat",
                description: "Nutrition comes first. You read menus carefully, know your macros, and always ask about preparation methods. Your coworkers come to you for healthy recommendations.",
                strengths: ["Consistent healthy choices", "Knows nutritional values", "Great self-discipline", "Inspires others"],
                weaknesses: ["Can be perceived as picky", "Limited spontaneity", "May struggle with group choices"],
                appHook: "Filter by dietary needs instantly",
                famousExamples: ["Tom Brady", "Gwyneth Paltrow", "Jennifer Aniston"],
                color: "#84CC16",
                percentage: 5
            },
            mood: {
                name: "The Mood Eater",
                emoji: "ðŸŽ­",
                tagline: "What sounds good RIGHT NOW?",
                description: "Your lunch choice depends entirely on how you're feeling. Stressed? Comfort food. Energized? Something light. Celebrating? Treat yourself. You trust your gut (literally) and let your cravings guide you.",
                strengths: ["In tune with your body", "Flexible and spontaneous", "Always satisfied", "Embraces variety"],
                weaknesses: ["Hard to plan ahead", "Can frustrate group decisions", "May eat emotionally"],
                appHook: "Tell us your mood, we'll match the food",
                famousExamples: ["Lizzo", "Post Malone", "Mindy Kaling"],
                color: "#A855F7",
                percentage: 2
            }
        };

        // Quiz State
        let currentQuestion = 0;
        let answers = [];
        let scores = {
            optimizer: 0, explorer: 0, habit: 0, social: 0,
            budget: 0, foodie: 0, health: 0, mood: 0
        };

        // DOM Elements
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const progressPercent = document.getElementById('progress-percent');
        const questionText = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const quizContent = document.getElementById('quiz-content');
        const resultsContent = document.getElementById('results-content');

        // Initialize
        function init() {
            feather.replace();
            renderQuestion();
            updateLiveCount();
        }

        // Update live count randomly
        function updateLiveCount() {
            const baseCount = 2847;
            const variation = Math.floor(Math.random() * 100) - 50;
            document.getElementById('live-count').textContent = (baseCount + variation).toLocaleString();
        }

        // Render current question
        function renderQuestion() {
            const q = questions[currentQuestion];
            const progress = ((currentQuestion + 1) / questions.length) * 100;

            progressBar.style.width = `${progress}%`;
            progressText.textContent = `Question ${currentQuestion + 1} of ${questions.length}`;
            progressPercent.textContent = `${Math.round(progress)}%`;

            questionText.textContent = q.question;

            optionsContainer.innerHTML = q.options.map((opt, i) => `
                <button onclick="selectOption(${i})" class="quiz-option w-full text-left p-4 rounded-xl border-2 border-stone-200 bg-white hover:border-orange-300 transition-all flex items-center gap-3">
                    <div class="w-6 h-6 rounded-full border-2 border-stone-300 flex items-center justify-center flex-shrink-0">
                        <div class="w-3 h-3 rounded-full bg-orange-500 opacity-0 transition-opacity"></div>
                    </div>
                    <span class="text-stone-700 font-medium">${opt.text}</span>
                </button>
            `).join('');
        }

        // Handle option selection
        function selectOption(index) {
            const q = questions[currentQuestion];
            const option = q.options[index];

            // Add points
            Object.entries(option.points).forEach(([type, pts]) => {
                scores[type] += pts;
            });

            answers.push(option);

            // Visual feedback
            const buttons = optionsContainer.querySelectorAll('button');
            buttons[index].classList.add('selected');
            buttons[index].querySelector('.w-3').classList.remove('opacity-0');

            // Disable all buttons
            buttons.forEach(btn => btn.disabled = true);

            // Move to next question or show results
            setTimeout(() => {
                if (currentQuestion < questions.length - 1) {
                    currentQuestion++;
                    document.getElementById('question-card').classList.remove('animate-fade-in');
                    setTimeout(() => {
                        renderQuestion();
                        document.getElementById('question-card').classList.add('animate-fade-in');
                    }, 150);
                } else {
                    showResults();
                }
            }, 400);
        }

        // Calculate and show results
        async function showResults() {
            // Find highest scoring personality
            const maxScore = Math.max(...Object.values(scores));
            const result = Object.entries(scores).find(([, score]) => score === maxScore)[0];
            const personality = personalities[result];

            // Get UTM parameters from URL
            const urlParams = new URLSearchParams(window.location.search);
            const source = urlParams.get('utm_source');
            const medium = urlParams.get('utm_medium');
            const campaign = urlParams.get('utm_campaign');
            const referrerCode = urlParams.get('ref');

            // Save to Supabase
            try {
                const { data, error } = await supabase.rpc('submit_quiz_result', {
                    p_personality_type: result,
                    p_answers: answers.map((a, i) => ({ question: questions[i].id, answer: a.text })),
                    p_scores: scores,
                    p_source: source,
                    p_medium: medium,
                    p_campaign: campaign,
                    p_referrer_code: referrerCode,
                    p_user_agent: navigator.userAgent
                });

                if (error) {
                    console.error('Error saving quiz result:', error);
                } else {
                    currentResultId = data;
                    console.log('Quiz result saved:', currentResultId);
                }
            } catch (err) {
                console.error('Failed to save quiz result:', err);
            }

            // Hide quiz, show results
            quizContent.classList.add('hidden');
            resultsContent.classList.remove('hidden');

            // Update page metadata for sharing
            document.title = `I'm a ${personality.name}! | Lunch Personality Quiz`;

            resultsContent.innerHTML = `
                <div class="animate-fade-in">
                    <!-- Confetti placeholder -->
                    <div class="absolute top-0 left-0 w-full pointer-events-none overflow-hidden h-32">
                        <div class="confetti absolute left-1/4 w-3 h-3 bg-orange-400 rounded"></div>
                        <div class="confetti absolute left-1/2 w-2 h-2 bg-pink-400 rounded" style="animation-delay: 0.1s"></div>
                        <div class="confetti absolute left-3/4 w-3 h-3 bg-yellow-400 rounded" style="animation-delay: 0.2s"></div>
                    </div>

                    <!-- Result Header -->
                    <div class="text-center mb-8">
                        <p class="text-lg text-stone-500 mb-2">Your Lunch Personality is...</p>
                        <div class="text-7xl mb-4">${personality.emoji}</div>
                        <h1 class="text-4xl font-bold text-stone-900 mb-2">${personality.name}</h1>
                        <p class="text-xl font-medium italic" style="color: ${personality.color}">"${personality.tagline}"</p>
                        <p class="mt-2 text-sm text-stone-400">${personality.percentage}% of quiz takers share this personality</p>
                    </div>

                    <!-- Description -->
                    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6">
                        <p class="text-lg text-stone-700 leading-relaxed mb-8">${personality.description}</p>

                        <div class="grid md:grid-cols-2 gap-6">
                            <div>
                                <h3 class="font-semibold text-stone-900 mb-3 flex items-center gap-2">
                                    <span class="text-green-500">âœ“</span> Your Strengths
                                </h3>
                                <ul class="space-y-2">
                                    ${personality.strengths.map(s => `<li class="text-stone-600 flex items-start gap-2"><span class="text-green-500 mt-1">â€¢</span>${s}</li>`).join('')}
                                </ul>
                            </div>
                            <div>
                                <h3 class="font-semibold text-stone-900 mb-3 flex items-center gap-2">
                                    <span class="text-orange-500">!</span> Watch Out For
                                </h3>
                                <ul class="space-y-2">
                                    ${personality.weaknesses.map(w => `<li class="text-stone-600 flex items-start gap-2"><span class="text-orange-500 mt-1">â€¢</span>${w}</li>`).join('')}
                                </ul>
                            </div>
                        </div>

                        <div class="mt-8 pt-6 border-t border-stone-100">
                            <h3 class="font-semibold text-stone-900 mb-3">Famous ${personality.name}s</h3>
                            <div class="flex flex-wrap gap-2">
                                ${personality.famousExamples.map(ex => `<span class="px-3 py-1 bg-stone-100 rounded-full text-sm text-stone-700">${ex}</span>`).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- App CTA -->
                    <div class="gradient-bg rounded-2xl p-6 md:p-8 text-white mb-6">
                        <h2 class="text-2xl font-bold mb-2">LunchNear.me was built for ${personality.name}s like you</h2>
                        <p class="text-white/90 mb-4">${personality.appHook}</p>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <a href="https://play.google.com/store/apps/details?id=com.lunchnear.me" target="_blank" class="flex items-center justify-center gap-2 bg-white text-stone-900 font-semibold py-3 px-6 rounded-lg hover:bg-stone-100 transition-colors">
                                <svg viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                    <path d="M3.609 1.814L13.792 12 3.61 22.186a.996.996 0 01-.61-.92V2.734a1 1 0 01.609-.92zm10.89 10.893l2.302 2.302-10.937 6.333 8.635-8.635zm3.199-3.198l2.807 1.626a1 1 0 010 1.73l-2.808 1.626L15.206 12l2.492-2.491zM5.864 2.658L16.8 8.99l-2.302 2.302-8.634-8.634z"/>
                                </svg>
                                Download for Android
                            </a>
                            <a href="index.html#download" class="flex items-center justify-center gap-2 bg-white/20 text-white font-semibold py-3 px-6 rounded-lg hover:bg-white/30 transition-colors">
                                iOS Coming Soon
                            </a>
                        </div>
                    </div>

                    <!-- Share -->
                    <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8 mb-6">
                        <h2 class="text-xl font-bold text-stone-900 mb-4 text-center">Share Your Result</h2>
                        <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
                            <button onclick="shareTwitter('${result}')" class="flex items-center gap-2 bg-black text-white px-5 py-3 rounded-lg hover:bg-stone-800 transition-colors w-full sm:w-auto justify-center">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                                Share on X
                            </button>
                            <button onclick="shareLinkedIn('${result}')" class="flex items-center gap-2 bg-[#0A66C2] text-white px-5 py-3 rounded-lg hover:bg-[#004182] transition-colors w-full sm:w-auto justify-center">
                                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg>
                                Share on LinkedIn
                            </button>
                            <button onclick="copyLink('${result}')" id="copy-btn" class="flex items-center gap-2 bg-stone-100 text-stone-700 px-5 py-3 rounded-lg hover:bg-stone-200 transition-colors w-full sm:w-auto justify-center">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg>
                                Copy Link
                            </button>
                        </div>
                    </div>

                    <!-- Email Capture -->
                    <div class="bg-stone-50 rounded-2xl p-6 md:p-8 mb-6">
                        <div class="text-center">
                            <h3 class="text-xl font-bold text-stone-900 mb-2">Get Your Full Lunch Profile</h3>
                            <p class="text-stone-600 mb-4">Weekly tips tailored for your personality + early access to new features</p>
                            <form onsubmit="handleEmailSubmit(event, '${result}')" class="max-w-md mx-auto">
                                <div class="flex flex-col sm:flex-row gap-3">
                                    <input type="email" id="email-input" placeholder="Enter your email" required class="flex-1 px-4 py-3 border-2 border-stone-200 rounded-lg focus:outline-none focus:border-orange-500 transition-colors">
                                    <button type="submit" class="gradient-bg text-white font-semibold px-6 py-3 rounded-lg hover:opacity-90 transition-colors">Get My Tips</button>
                                </div>
                            </form>
                            <p class="text-xs text-stone-400 mt-3">No spam, unsubscribe anytime.</p>
                        </div>
                    </div>

                    <!-- All Personalities -->
                    <div class="mb-8">
                        <h2 class="text-xl font-bold text-stone-900 mb-6 text-center">Compare With Friends</h2>
                        <div class="grid grid-cols-2 sm:grid-cols-4 gap-3">
                            ${Object.entries(personalities).map(([key, p]) => `
                                <button onclick="showPersonality('${key}')" class="p-4 rounded-xl text-center transition-all ${key === result ? 'bg-orange-100 border-2 border-orange-500' : 'bg-white border-2 border-stone-100 hover:border-orange-200'}">
                                    <span class="text-3xl block mb-2">${p.emoji}</span>
                                    <span class="text-sm font-medium text-stone-700">${p.name}</span>
                                    <span class="text-xs text-stone-500 block">${p.percentage}%</span>
                                </button>
                            `).join('')}
                        </div>
                    </div>

                    <!-- Retake -->
                    <div class="text-center">
                        <button onclick="retakeQuiz()" class="text-orange-500 hover:text-orange-600 font-medium inline-flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                            Retake the Quiz
                        </button>
                    </div>
                </div>
            `;
        }

        // Share functions with tracking
        async function trackShare(platform, type) {
            if (!currentResultId) return null;

            try {
                const { data, error } = await supabase.rpc('create_quiz_share', {
                    p_result_id: currentResultId,
                    p_platform: platform
                });

                if (error) {
                    console.error('Error tracking share:', error);
                    return null;
                }
                return data; // Returns referral code
            } catch (err) {
                console.error('Failed to track share:', err);
                return null;
            }
        }

        async function shareTwitter(type) {
            const p = personalities[type];
            const refCode = await trackShare('twitter', type);
            const text = `I'm a ${p.name} ${p.emoji}! What's YOUR lunch personality? Take the quiz:`;
            const url = refCode
                ? `https://lunchnear.me/quiz.html?ref=${refCode}`
                : `https://lunchnear.me/quiz.html?result=${type}`;
            window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank', 'width=550,height=420');
        }

        async function shareLinkedIn(type) {
            const refCode = await trackShare('linkedin', type);
            const url = refCode
                ? `https://lunchnear.me/quiz.html?ref=${refCode}`
                : `https://lunchnear.me/quiz.html?result=${type}`;
            window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${encodeURIComponent(url)}`, '_blank', 'width=550,height=420');
        }

        async function copyLink(type) {
            const refCode = await trackShare('copy', type);
            const url = refCode
                ? `https://lunchnear.me/quiz.html?ref=${refCode}`
                : `https://lunchnear.me/quiz.html?result=${type}`;
            navigator.clipboard.writeText(url).then(() => {
                const btn = document.getElementById('copy-btn');
                btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/></svg> Copied!';
                btn.classList.add('bg-green-500', 'text-white');
                btn.classList.remove('bg-stone-100', 'text-stone-700');
                setTimeout(() => {
                    btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3"/></svg> Copy Link';
                    btn.classList.remove('bg-green-500', 'text-white');
                    btn.classList.add('bg-stone-100', 'text-stone-700');
                }, 2000);
            });
        }

        async function handleEmailSubmit(e, type) {
            e.preventDefault();
            const emailInput = document.getElementById('email-input');
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const email = emailInput.value;

            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            // Disable form while submitting
            emailInput.disabled = true;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            try {
                if (currentResultId) {
                    // Update the quiz result with email
                    const { error } = await supabase.rpc('capture_quiz_email', {
                        p_result_id: currentResultId,
                        p_email: email
                    });

                    if (error) {
                        console.error('Error saving email:', error);
                        alert('Something went wrong. Please try again.');
                        emailInput.disabled = false;
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Get My Tips';
                        return;
                    }
                } else {
                    // Fallback: insert directly if no result ID
                    const { error } = await supabase.from('quiz_results').insert({
                        email: email,
                        personality_type: type,
                        answers: [],
                        scores: {}
                    });

                    if (error) {
                        console.error('Error saving email:', error);
                        alert('Something went wrong. Please try again.');
                        emailInput.disabled = false;
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'Get My Tips';
                        return;
                    }
                }

                // Show success state
                e.target.innerHTML = `
                    <div class="text-center py-4">
                        <div class="text-4xl mb-3">ðŸŽ‰</div>
                        <h3 class="text-xl font-bold text-stone-900 mb-2">You're In!</h3>
                        <p class="text-stone-600">Check your inbox for your personalized lunch tips and full personality breakdown.</p>
                    </div>
                `;
            } catch (err) {
                console.error('Failed to save email:', err);
                alert('Something went wrong. Please try again.');
                emailInput.disabled = false;
                submitBtn.disabled = false;
                submitBtn.textContent = 'Get My Tips';
            }
        }

        function showPersonality(type) {
            // For now, just highlight - could expand to show that personality's details
            console.log('Show personality:', type);
        }

        function retakeQuiz() {
            currentQuestion = 0;
            answers = [];
            scores = { optimizer: 0, explorer: 0, habit: 0, social: 0, budget: 0, foodie: 0, health: 0, mood: 0 };
            quizContent.classList.remove('hidden');
            resultsContent.classList.add('hidden');
            renderQuestion();
        }

        // Check if coming from a shared result link
        function checkSharedResult() {
            const params = new URLSearchParams(window.location.search);
            const result = params.get('result');
            if (result && personalities[result]) {
                // Show that personality's result directly
                quizContent.classList.add('hidden');
                resultsContent.classList.remove('hidden');
                const personality = personalities[result];
                document.title = `I'm a ${personality.name}! | Lunch Personality Quiz`;
                // Populate results (simplified version)
                resultsContent.innerHTML = `
                    <div class="text-center mb-8">
                        <p class="text-lg text-stone-500 mb-2">This person's Lunch Personality is...</p>
                        <div class="text-7xl mb-4">${personality.emoji}</div>
                        <h1 class="text-4xl font-bold text-stone-900 mb-2">${personality.name}</h1>
                        <p class="text-xl font-medium italic" style="color: ${personality.color}">"${personality.tagline}"</p>
                    </div>
                    <div class="text-center">
                        <p class="text-stone-600 mb-6">Want to discover YOUR lunch personality?</p>
                        <button onclick="retakeQuiz()" class="gradient-bg text-white font-semibold px-8 py-4 rounded-xl hover:opacity-90 transition-colors">
                            Take the Quiz
                        </button>
                    </div>
                `;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkSharedResult();
            if (!new URLSearchParams(window.location.search).get('result')) {
                init();
            }
            feather.replace();
        });
    </script>
</body>
</html>
